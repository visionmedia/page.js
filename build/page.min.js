(function(){function page(path,fn){if("function"==typeof fn){var route=new Route(path);for(var i=1;i<arguments.length;++i)page.callbacks.push(route.middleware(arguments[i]))}else"string"==typeof path?page.show(path,fn):page.start(path)}function unhandled(ctx){if(window.location.pathname==ctx.canonicalPath)return;page.stop(),ctx.unhandled=!0,window.location=ctx.canonicalPath}function Context(path,state){"/"==path[0]&&0!=path.indexOf(base)&&(path=base+path);var i=path.indexOf("?");this.canonicalPath=path,this.path=path.replace(base,"")||"/",this.title=document.title,this.state=state||{},this.state.path=path,this.querystring=~i?path.slice(i+1):"",this.pathname=~i?path.slice(0,i):path,this.params=[]}function Route(path,options){options=options||{},this.path=path,this.method="GET",this.regexp=pathtoRegexp(path,this.keys=[],options.sensitive,options.strict)}function pathtoRegexp(path,keys,sensitive,strict){return path instanceof RegExp?path:(path instanceof Array&&(path="("+path.join("|")+")"),path=path.concat(strict?"":"/?").replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(_,slash,format,key,capture,optional){return keys.push({name:key,optional:!!optional}),slash=slash||"",""+(optional?"":slash)+"(?:"+(optional?slash:"")+(format||"")+(capture||format&&"([^/.]+?)"||"([^/]+?)")+")"+(optional||"")}).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)"),new RegExp("^"+path+"$",sensitive?"":"i"))}function onpopstate(e){if(e.state){var path=e.state.path;page.replace(path,e.state)}}function onclick(e){if(e.defaultPrevented)return;var el=e.target;while(el&&"A"!=el.nodeName)el=el.parentNode;if(!el||"A"!=el.nodeName)return;var href=el.href,path=el.pathname+el.search;if(el.hash)return;if(!sameOrigin(href))return;var orig=path;path=path.replace(base,"");if(base&&orig==path)return;e.preventDefault(),page.show(orig)}function sameOrigin(href){var origin=location.protocol+"//"+location.hostname;return location.port&&(origin+=":"+location.port),0==href.indexOf(origin)}var dispatch=!0,base="",running;page.callbacks=[],page.base=function(path){if(0==arguments.length)return base;base=path},page.start=function(options){options=options||{};if(running)return;running=!0,window.addEventListener&&window.history&&window.history.pushState||(options.popstate=options.click=!1),!1===options.dispatch&&(dispatch=!1),!1!==options.popstate&&addEventListener("popstate",onpopstate,!1),!1!==options.click&&addEventListener("click",onclick,!1);if(!dispatch)return;page.replace(location.pathname+location.search,null,!0,dispatch)},page.stop=function(){running=!1,window.removeEventListener&&(removeEventListener("click",onclick,!1),removeEventListener("popstate",onpopstate,!1))},page.show=function(path,state){var ctx=new Context(path,state);return page.dispatch(ctx),ctx.unhandled||ctx.pushState(),ctx},page.replace=function(path,state,init,dispatch){var ctx=new Context(path,state);return ctx.init=init,null==dispatch&&(dispatch=!0),dispatch&&page.dispatch(ctx),ctx.save(),ctx},page.dispatch=function(ctx){function next(){var fn=page.callbacks[i++];if(!fn)return unhandled(ctx);fn(ctx,next)}var i=0;next()},Context.prototype.pushState=function(){if(!window.history||!window.history.pushState)location=this.canonicalPath;history.pushState(this.state,this.title,this.canonicalPath)},Context.prototype.save=function(){window.history&&window.history.replaceState&&history.replaceState(this.state,this.title,this.canonicalPath)},Route.prototype.middleware=function(fn){var self=this;return function(ctx,next){if(self.match(ctx.path,ctx.params))return fn(ctx,next);next()}},Route.prototype.match=function(path,params){var keys=this.keys,qsIndex=path.indexOf("?"),pathname=~qsIndex?path.slice(0,qsIndex):path,m=this.regexp.exec(pathname);if(!m)return!1;for(var i=1,len=m.length;i<len;++i){var key=keys[i-1],val="string"==typeof m[i]?decodeURIComponent(m[i]):m[i];key?params[key.name]=undefined!==params[key.name]?params[key.name]:val:params.push(val)}return!0},"undefined"==typeof module?window.page=page:module.exports=page})();